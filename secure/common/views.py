import hashlib
import random
import secrets
import string
from datetime import datetime

from common.models import Enquiry, Users
from django.contrib.auth.models import User
from django.http import Http404
from django.shortcuts import HttpResponseRedirect, redirect, render
from django.contrib.auth.hashers import check_password
from django.urls import reverse
from django.contrib import messages

# Create your views here.

def genRandomId():
    alphabet = string.ascii_letters + string.digits
    id = ''.join(secrets.choice(alphabet) for i in range(8))
    return hashlib.md5(id.encode('utf-8')).hexdigest()

def index(request):
    return render(request,'common/index.html', {})

def contactUs(request):
    return render(request, 'common/contactus.html', {})

def about(request):
    return render(request, 'common/about.html', {})

def ourDoctors(request):
    results = Users.objects.filter(role = "doctor")
    for x in results:
        print(x.getName())
    return render(request,'common/ourdoctors.html', {'results': results})

def generalEnquiries(request):
    if request.method == 'POST':
        name = request.POST.get('name')
        email = request.POST.get('email')
        enquiry = request.POST.get('enquiry')
        current_time = datetime.now().strftime("%d/%m/%Y %H:%M:%S")
        enquiryId = genRandomId()
        try:
            newEnquiry = Enquiry(name = name, email = email, datetime = current_time, enquiryid = enquiryId, enquiry=enquiry)
            newEnquiry.save()
            return render(request, 'common/enquiry.html', {'successMessage':"Your Enquiry has been submitted"})
        except:
            return render(request, 'common/enquiry.html', {'errorMessage':"An error has occured. Please contact our helpdesk for assistance"})
    else:
        results = Enquiry.objects.all()
        return render(request, 'common/enquiry.html', {})

def changePassword(request, username):
    user = Users.objects.filter(username = username)
    authUser = User.objects.get(username = username)
    role = user[0].getRole()
    errorMessage = None
    successMessage = None
    if role is None:
        raise Http404
    else:
        if request.method == 'POST':
            oldpassword = request.POST.get('oldpassword')
            newpassword = request.POST.get('newpassword')
            repeatpassword = request.POST.get('repeatpassword')
            if check_password(oldpassword, authUser.password) == False or newpassword != repeatpassword:
                errorMessage = "An error has occured. Please try again!"
                return render(request, 'common/changepassword.html', {'username': username, 'role': role, 'errorMessage': errorMessage})
            else:
                authUser.set_password(newpassword)
                authUser.save()
                print("change password")
                return HttpResponseRedirect(reverse('common:index'))
        return render(request, 'common/changepassword.html', {'username': username, 'role': role})
